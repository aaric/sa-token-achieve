# sa-token-achieve

[![License](https://img.shields.io/badge/License-GPL--3.0-green.svg?style=flat&logo=data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwIj4KICA8cGF0aCBmaWxsPSIjZmZmIiBkPSJNOTQuMjkxNDk4IDE5OS42NzY0NWMtMTguMjYwNzczLTEuMzY5MzMtMzQuMzkzOTE5LTYuNzAyMzktNDguNzg1NDI1LTE2LjEyNjc3LTI0LjA3MjE2Mi0xNS43NjM4My0zOS45NjMyNTExLTQwLjc3MDA5LTQ0LjM5ODQxMzEtNjkuODY1NDctLjg3OTAxMjEzLTUuNzY2NDYtLjk4NjYwMzIyLTIwLjE4NDQ5My0uMTkzMzUyMjEtMjUuOTEwOTMxQzQuMTkyMjc1MyA2NC4xMDk4MSAxNC4zNjkwNDUgNDMuOTc5NTA2IDMxLjIxMDc3MyAyNy44NDQ5MjdjNy42NjEwNjEtNy4zMzkzODQgMTUuMzExMzA4LTEyLjY1ODczNyAyNS4wMjQwNDUtMTcuMzk5NjU2IDkuNDQ3NjU2LTQuNjExNTMwMSAxOC42NDk0NzgtNy41NDg1Nzg3IDI4LjU0MjUxLTkuMTEwMjM0NkM5MS4yNjEwMjguMzExNTU4NyAxMDQuMzk4NTEuMDg3MzkyNzEgMTExLjI0MjU4Ljg4MzQ1NzQ5IDEzMC4xMDg0OSAzLjA3NzgzODEgMTQ3Ljk0MjA3IDEwLjU1ODYzNiAxNjIuNzEyNTUgMjIuNDczOTg0YzQuODQ3MzUgMy45MTAzNTYgMTIuMzc3MzQgMTEuNTU5MzI4IDE2LjA1NzcxIDE2LjMxMTQ0MSAxMS43MDY3NiAxNS4xMTU4MjYgMTguNzU0MjkgMzIuOTc3MDMyIDIwLjYwNzIxIDUyLjIyNjcyMS41ODU4MSA2LjA4NTg5OS4yODM0NyAxNy40MDYyNzQtLjYyNzEzIDIzLjQ4MTc4NC02LjUxOTI5IDQzLjQ5NjQ0LTQwLjU2NTQ1IDc3LjYwMTAxLTg0LjAxMzUgODQuMTU3NjUtNS4yNDk5OS43OTIyOC0xNi4yMTY0ODQgMS4zNDE5OS0yMC40NDUzNDIgMS4wMjQ4N3ptMTIuOTg2MzYyLTIyLjg2NDg0YzkuMTk0OTktLjkwNTE2IDE3LjY1NjYzLTMuMjczNDYgMjYuMDIzNTMtNy4yODM2NyAyNi45Mjc4Mi0xMi45MDYzNSA0My43ODM2My0zOS42NTMzMiA0My43ODM2My02OS40NzYzNCAwLTI2LjI1NjMzNy0xMy4wMjQ5Mi01MC4yODIwNy0zNS4xMjczMS02NC43OTU3MTctNy40ODgwOS00LjkxNzA5OC0xNy4yNjQyLTguOTE4NjQ4LTI2LjYwMDM3LTEwLjg4ODA0NS02LjY2NjUzLTEuNDA2MjYzLTE4Ljc5OTY1Ni0xLjc3ODIzNS0yNS44NDM1My0uNzkyMzA0LTI1LjUyNDY5NyAzLjU3MjY4NS00Ny42NDU3MzMgMTkuNTc0Njc3LTU4LjgwMzk2NCA0Mi41Mzc4MjYtMjAuNDQzMTMzIDQyLjA3MTA5LjY1NTY0OCA5Mi4zMDY5IDQ0Ljk1ODE3IDEwNy4wNDQ1NiAxMC41NDEyMjMgMy41MDY2MiAyMC45MTg2MzYgNC43MDYxMyAzMS42MDk4NDQgMy42NTM2OXoiLz4KICA8cGF0aCBmaWxsPSIjZmZmIiBkPSJNOTEuODYyMzQ4IDE1My4xODIzNmMtMTYuNjYxMTY2LTIuNzgyNDktMzAuMjg3NzYxLTEyLjIxMjE3LTM4LjU5OTM4LTI2LjcxMTAxLTMuMzA0MTQ2LTUuNzYzNzgtNS40MDM4MjYtMTEuOTU2MS02LjU2NTY2NC0xOS4zNjMzMi0uNjIzNDc0LTMuOTc0ODgtLjI3Mjk1Mi0xMy45NjA3NzUuNjM2MDQ0LTE4LjEyMDE3NiA0LjAyMjE2Ni0xOC40MDQ3MzMgMTcuNDIxOTg4LTMzLjY3MTM3MiAzNC44NTgwNTMtMzkuNzE0MzYgMTEuMzg5NTc1LTMuOTQ3Mzk3IDI0LjE0OTk1OS0zLjk0NzI1NSAzNS41MzYyMjkuMDAwNDA1IDE1Ljk3MTQ4IDUuNTM3MzcyIDI4LjUwMDUgMTguNTAyMTU0IDMzLjYwNjQ3IDM0Ljc3NTM0LjU4MDAyIDEuODQ4NTQyIDEuMDU0NTYgMy41MzM3NjEgMS4wNTQ1NiAzLjc0NDkzOSAwIC4yMzMyMDMtNC42MDE0My4zODM5Ni0xMS43MTg4MS4zODM5NmgtMTEuNzE4ODFsLTEuNDQ5Ny0yLjc1ODc2NmMtMy45NDIxOC03LjUwMTk4Ny0xMS4yNjA1NC0xMy4zMDQ1NzQtMTkuNTkyMTctMTUuNTM0MjQyLTQuMDM4NjYtMS4wODA4MS0xMS4xODg1OTktMS4xNjQ2NjgtMTUuMjM3MTA1LS4xNzg3MTctMy44MDczMTIuOTI3MjEtOC44OTMyOTIgMy40NDE1NzktMTEuOTkyMTY2IDUuOTI4NTkxLTQuODQwMDg5IDMuODg0NDIxLTguMTQwMTEgOC41NzI0NDUtMTAuMTc5OTYgMTQuNDYxNjcyLTEuNTQ4MDI4IDQuNDY5MjYzLTEuOTY5MjcxIDExLjQ4MDM1NC0uOTcxNTMgMTYuMTY5NzY0IDMuMTIyOTE1IDE0LjY3Nzc4IDE1LjcxMzczMyAyNC44NTEwNyAzMC43MTc2ODEgMjQuODE5NjUgMTEuNTM2MDUtLjAyNDE2IDIyLjM3NTgyLTYuNzEzMzIgMjcuNDQ5MTgtMTYuOTM4NzNsMS4yMzQxNS0yLjQ4NzQ0aDIzLjUyMzU5bC0uMjc0MDQgMS4zMTU3OWMtLjUyNDEyIDIuNTE2NS0yLjMzNTc5IDcuNDA4NTItMy45MzU3MyAxMC42Mjc1My03LjQ5MzUyIDE1LjA3NjY3LTIwLjk1MiAyNS41MjM0My0zNy41NTQ5OCAyOS4xNTA5Ni00LjEwODU1Ljg5NzY3LTE0LjU4NzUyMyAxLjEzNTk5LTE4LjgyNTkxMi40MjgxNnoiLz4KPC9zdmc+)](https://www.gnu.org/licenses/gpl-3.0.html)
[![OracleJDK](https://img.shields.io/badge/OracleJDK-1.8.0__202-success.svg?style=flat&logo=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDMyIDMyIj48cGF0aCBkPSJNMTEuNjIyIDI0Ljc0cy0xLjIzLjc0OC44NTUuOTYyYzIuNTEuMzIgMy44NDcuMjY3IDYuNjI1LS4yNjdhMTAuMDIgMTAuMDIgMCAwIDAgMS43NjMuODU1Yy02LjI1IDIuNjcyLTE0LjE2LS4xNi05LjI0NC0xLjU1em0tLjgtMy40NzNzLTEuMzM2IDEuMDE1Ljc0OCAxLjIzYzIuNzI1LjI2NyA0Ljg2Mi4zMiA4LjU1LS40MjdhMy4yNiAzLjI2IDAgMCAwIDEuMjgyLjgwMWMtNy41MzQgMi4yNDQtMTUuOTc2LjIxNC0xMC41OC0xLjYwM3ptMTQuNzQ3IDYuMDlzLjkwOC43NDgtMS4wMTUgMS4zMzZjLTMuNTggMS4wNy0xNS4wMTQgMS4zOS0xOC4yMiAwLTEuMTIyLS40OCAxLjAxNS0xLjE3NSAxLjctMS4yODIuNjk1LS4xNiAxLjA3LS4xNiAxLjA3LS4xNi0xLjIzLS44NTUtOC4xNzUgMS43NjMtMy41MjYgMi41MSAxMi43NyAyLjA4NCAyMy4yOTYtLjkwOCAxOS45ODMtMi40MDR6TTEyLjIgMTcuNjMzcy01LjgyNCAxLjM5LTIuMDg0IDEuODdjMS42MDMuMjE0IDQuNzU1LjE2IDcuNjk0LS4wNTMgMi40MDQtLjIxNCA0LjgxLS42NCA0LjgxLS42NHMtLjg1NS4zNzQtMS40NDMuNzQ4Yy01LjkzIDEuNTUtMTcuMzEyLjg1NS0xNC4wNTItLjc0OCAyLjc3OC0xLjMzNiA1LjA3Ni0xLjE3NSA1LjA3Ni0xLjE3NXptMTAuNDIgNS44MjRjNS45ODQtMy4xIDMuMjA2LTYuMDkgMS4yODItNS43MTctLjQ4LjEwNy0uNjk1LjIxNC0uNjk1LjIxNHMuMTYtLjMyLjUzNC0uNDI3YzMuNzk0LTEuMzM2IDYuNzg2IDQuMDA3LTEuMjMgNi4wOSAwIDAgLjA1My0uMDUzLjEwNy0uMTZ6bS05LjgzIDguNDQyYzUuNzcuMzc0IDE0LjU4Ny0uMjE0IDE0LjgtMi45NCAwIDAtLjQyNyAxLjA3LTQuNzU1IDEuODctNC45MTYuOTA4LTExLjAwNy44LTE0LjU4Ny4yMTQgMCAwIC43NDguNjQgNC41NDIuODU1eiIgZmlsbD0iIzRlNzg5NiIvPjxwYXRoIGQ9Ik0xOC45OTYuMDAxczMuMzEzIDMuMzY2LTMuMTUyIDguNDQyYy01LjE4MyA0LjExNC0xLjE3NSA2LjQ2NSAwIDkuMTM3LTMuMDQ2LTIuNzI1LTUuMjM2LTUuMTMtMy43NC03LjM3M0MxNC4yOTQgNi44OTMgMjAuMzMyIDUuMyAxOC45OTYuMDAxem0tMS43IDE1LjMzNWMxLjU1IDEuNzYzLS40MjcgMy4zNjYtLjQyNyAzLjM2NnMzLjk1NC0yLjAzIDIuMTM3LTQuNTQyYy0xLjY1Ni0yLjQwNC0yLjk0LTMuNTggNC4wMDctNy41ODcgMCAwLTEwLjk1MyAyLjcyNS01LjcxNyA4Ljc2M3oiIGZpbGw9IiNmNTgyMTkiLz48L3N2Zz4=)](https://www.oracle.com/java/technologies/javase/jdk17-archive-downloads.html)
[![JUnit](https://img.shields.io/badge/JUnit-5.6.3-success.svg?style=flat&logo=junit5)](https://junit.org/junit5/docs/current/user-guide)
[![Gradle](https://img.shields.io/badge/Gradle-7.4.2-success.svg?style=flat&logo=gradle)](https://docs.gradle.org/7.4/userguide/installation.html)
[![Release](https://img.shields.io/badge/Release-0.12.0-informational.svg)](https://github.com/aaric/sa-token-achieve/releases)

> *[Sa-Token：一个轻量级 Java 权限认证框架，让鉴权变得简单、优雅！](https://sa-token.cc/doc.html)*

## 1 Redis

### 1.1 build.gradle

```groovy
dependencies {
    implementation "cn.dev33:sa-token-spring-boot-starter"
    implementation "cn.dev33:sa-token-dao-redis-jackson"
    implementation "org.apache.commons:commons-pool2"
}
```

### 1.2 application.yml

```yaml
# Spring settings
spring:
  redis:
    database: 0
    host: localhost
    port: 6379
    #password:
    timeout: 10s
    lettuce:
      pool:
        max-active: 200
        max-wait: -1ms
        max-idle: 10
        min-idle: 0

# Sa-Token settings
sa-token:
  token-name: satoken
  timeout: 2592000
  activity-timeout: -1
  is-concurrent: true
  is-share: true
  token-style: tik
  token-prefix: Bearer
  is-log: false
```

## 2 Login Data

### 2.1 SaSession

```java
class SaSessionApi {
    public SaResult login(int loginId) {
        SaSession session = StpUtil.getSession();
        session.set("username", "someone");
    }
}
```

### 2.2 SaApplication

```java
class SaApplicationApi {
    public SaResult login(int loginId) {
        SaApplication application = SaHolder.getApplication();
        application.set(StpUtil.getLoginIdAsString() + ":username", "someone");
    }
}
```

### 2.3 Exception

|No.|Exception Class|Recommend Code|Remark|
|:---:|:---:|:---:|-----|
|1|`cn.dev33.satoken.exception.NotLoginException`|`401`|*UNAUTHORIZED*|
|2|`cn.dev33.satoken.exception.NotBasicAuthException`|`401`|*UNAUTHORIZED*|
|3|`cn.dev33.satoken.exception.NotSafeException`|`403`|*FORBIDDEN*|
|4|`cn.dev33.satoken.exception.NotRoleException`|`403`|*FORBIDDEN*|
|5|`cn.dev33.satoken.exception.NotPermissionException`|`403`|*FORBIDDEN*|

## 3 SkyWalking Integrated

### 3.1 Deploy

```bash
cat > docker-compose.yaml <<-'EOF'
version: "3"
services:
  skywalking-oap-server:
    image: apache/skywalking-oap-server:8.7.0-es7
    container_name: skywalking_community_edition
    environment:
      TZ: Asia/Shanghai
      SW_STORAGE: elasticsearch7
      SW_STORAGE_ES_CLUSTER_NODES: 127.0.0.1:9200
    ports:
      - 1234:1234
      - 11800:11800
      - 12800:12800
    restart: always
    deploy:
      restart_policy:
        condition: on-failure
  skywalking-ui:
    image: apache/skywalking-ui:8.7.0
    container_name: skywalking_ui_community_edition
    environment:
      TZ: Asia/Shanghai
      SW_OAP_ADDRESS: http://skywalking-oap-server:12800
    ports:
      - 8080:8080
    restart: always
    deploy:
      restart_policy:
        condition: on-failure
    depends_on:
      - skywalking-oap-server
EOF

# docker-compose down -v
docker-compose up -d
docker-compose ps
```

### 3.2 Java

### 3.2.1 Code

1. `build.gradle`

    ```groovy
    dependencies {
        implementation "org.apache.skywalking:apm-toolkit-logback-1.x:8.7.0"
    }
    ```

1. [`logback.xml`](sa-base-backend/src/main/resources/logback.xml)

### 3.2.2 Testing

```bash
# java agent
wget https://archive.apache.org/dist/skywalking/8.7.0/apache-skywalking-apm-bin-es7-8.7.0.tar.gz
tar -zxvf apache-skywalking-apm-es7-8.7.0.tar.gz

# add plugin config
cat >> apache-skywalking-apm-bin-es7/agent/config/agent.config <<-'EOF'

# gRPC log configuration
plugin.toolkit.log.grpc.reporter.server_host=${SW_GRPC_LOG_SERVER_HOST:127.0.0.1}
plugin.toolkit.log.grpc.reporter.server_port=${SW_GRPC_LOG_SERVER_PORT:11800}
plugin.toolkit.log.grpc.reporter.max_message_size=${SW_GRPC_LOG_MAX_MESSAGE_SIZE:10485760}
plugin.toolkit.log.grpc.reporter.upstream_timeout=${SW_GRPC_LOG_GRPC_UPSTREAM_TIMEOUT:30}
EOF

# env
export SERVER_PORT=8080
export SW_AGENT_COLLECTOR_BACKEND_SERVICES=10.0.11.21:11800
export SW_GRPC_LOG_SERVER_HOST=10.0.11.21
export SW_GRPC_LOG_SERVER_PORT=11800
export SW_AGENT_NAME=sa-base-backend

# boot run
java -javaagent:/path/to/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar -jar sa-base-backend-0.10.0.jar
```

### 3.2.3 Docker

&emsp;&emsp;略。
